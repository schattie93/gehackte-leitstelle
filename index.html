<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rettungsleitstelle â€“ Escape (ONLINE)</title>
  <meta name="theme-color" content="#070b10" />
  <style>
    :root{
      --bg:#070b10; --panel:#0b1220; --panel-2:#0e1a2c;
      --accent:#00ffc6; --accent-2:#7a5cff; --accent-3:#ff3b81;
      --text:#e6fff7; --muted:#9ad9c9; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family: ui-sans-serif, system-ui, Segoe UI, Inter, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1000px 600px at 20% -10%, rgba(0,255,198,.07), transparent),
        radial-gradient(1000px 600px at 120% 120%, rgba(255,59,129,.08), transparent),
        linear-gradient(180deg, #04060a, #0a0f17 60%, #04060a);
      overflow-y:auto;
    }
    .bg-grid:before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background-image:
        radial-gradient(circle at 25% 10%, rgba(122,92,255,.08), transparent 40%),
        radial-gradient(circle at 80% 90%, rgba(0,255,198,.08), transparent 40%),
        linear-gradient(transparent 24px, rgba(255,255,255,.05) 25px);
      background-size: 100% 100%, 100% 100%, 100% 25px;
      mix-blend-mode:screen; z-index:0;
    }
    .scanlines:after{
      content:""; position:fixed; inset:0; pointer-events:none;
      background: repeating-linear-gradient(180deg, rgba(0,255,198,.03), rgba(0,255,198,.03) 2px, transparent 2px, transparent 4px);
      opacity:.25; mix-blend-mode:overlay; z-index:0;
    }
    .app{position:relative; z-index:1; max-width:1200px; margin:0 auto; padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{display:grid; place-items:center; width:42px; height:42px; border-radius:12px;
      background: radial-gradient(100% 100% at 30% 20%, rgba(0,255,198,.25), rgba(122,92,255,.15) 55%, rgba(255,59,129,.12));
      border:1px solid rgba(255,255,255,.18); box-shadow:0 10px 40px rgba(0,0,0,.5), inset 0 0 40px rgba(0,255,198,.08)}
    .sig{font-weight:900; letter-spacing:.1em; text-transform:uppercase; font-size:1rem}
    .panel{background:linear-gradient(180deg, rgba(11,18,32,.95), rgba(11,18,32,.8));
      border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:20px; box-shadow:0 20px 80px rgba(0,0,0,.45), inset 0 0 80px rgba(0,255,198,.07)}
    .hero{border:1px dashed rgba(255,255,255,.15);
      background:linear-gradient(145deg, rgba(0,255,198,.09), rgba(122,92,255,.08), rgba(255,59,129,.08))}
    .title{font-size:1.6rem;font-weight:900;margin:0 0 6px}
    .subtitle{margin:0;color:var(--muted)}
    .grid{display:grid; gap:16px}
    .cols-2{grid-template-columns: repeat(2, minmax(0,1fr))}
    @media (max-width:900px){.cols-2{grid-template-columns:1fr}}
    .row{display:flex; gap:12px; align-items:center}
    .row > *{flex:1}
    .spc{height:14px}
    .btn{display:inline-flex;align-items:center;gap:10px; padding:.85rem 1.1rem; border-radius:14px; font-weight:800;
      background: linear-gradient(180deg, var(--accent), #42ffd6); color:#041014; border:1px solid rgba(255,255,255,.18);
      box-shadow:0 10px 30px rgba(0,255,198,.25), inset 0 -8px 18px rgba(0,0,0,.25); cursor:pointer}
    .btn:hover{filter:brightness(1.06)}
    .btn.secondary{background:linear-gradient(180deg, transparent, transparent); color:var(--accent); border:1px solid rgba(0,255,198,.35)}
    .btn.ghost{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,.15)}
    .btn.danger{background:linear-gradient(180deg, var(--danger), #ff8f8f); color:#180000}
    input, textarea, select{
      width:100%; padding:1rem; border-radius:14px; border:1px solid rgba(255,255,255,.14); outline:none;
      background:linear-gradient(180deg, #0a1422, #0b1a2a); color:var(--text); font-size:1rem}
    textarea{min-height:160px; resize:vertical}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.15); padding:.15rem .45rem; border-radius:6px}
    .pill{padding:.2rem .5rem; border-radius:999px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.05)}
    .progress{height:10px; background:#0c1828; border:1px solid rgba(255,255,255,.12); border-radius:999px; overflow:hidden}
    .progress > div{height:100%; background:linear-gradient(90deg,var(--accent), var(--accent-3)); width:0%}
    .muted{color:var(--muted)} .small{font-size:.85rem}
    .note{border:1px dashed rgba(255,255,255,.18); padding:.6rem .8rem; border-radius:12px; color:var(--muted)}
    .error-box{position:fixed;left:16px;right:16px;bottom:16px;z-index:99999;background:#2b0f13;border:1px solid #ff6b6b;color:#ffd6d6;border-radius:12px;padding:12px 14px;font-family:ui-monospace,monospace}
    /* Modal (sicher & scrollable) */
    .modal-overlay{position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9999; display:flex; align-items:flex-start; justify-content:center; padding:24px; overflow:auto;}
    .modal-panel{max-height:90vh; width:min(960px, calc(100vw - 32px)); overflow:auto; position:relative;}
    .modal-header{position:sticky; top:0; z-index:2; background:linear-gradient(180deg, rgba(14,26,44,.96), rgba(9,16,28,.92)); border-bottom:1px solid rgba(255,255,255,.12); margin:-20px -20px 12px -20px; padding:16px 20px;}
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-grid scanlines">
  <div class="app" id="app"></div>

  <script>
  (function(){
    'use strict';

    // ====== Firebase-Konfiguration (deine Werte) ======
    const FIREBASE_CFG = {
      apiKey: "AIzaSyCyBP1BnM_VUtSFCDMQNxKYyTY5Ga7XIrI",
      authDomain: "gehackte-leitstelle.firebaseapp.com",
      databaseURL: "https://gehackte-leitstelle-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gehackte-leitstelle",
      storageBucket: "gehackte-leitstelle.firebasestorage.app",
      messagingSenderId: "834048574525",
      appId: "1:834048574525:web:d975375eeceac7aea35654"
    };
    // ================================================

    // ---------- Error-Overlay ----------
    function showErrorBox(msg){
      try{
        const b = document.createElement('div');
        b.className = 'error-box';
        b.textContent = 'Fehler: ' + msg;
        document.body.appendChild(b);
        setTimeout(()=> b.remove(), 12000);
      }catch(e){}
    }
    window.addEventListener('error', e => showErrorBox(e.message || String(e)));
    window.addEventListener('unhandledrejection', e => showErrorBox(e?.reason?.message || String(e?.reason || e)));

    // ---------- Firebase ----------
    const appFB = firebase.initializeApp(FIREBASE_CFG);
    const db = firebase.database();
    const auth = firebase.auth();
    auth.signInAnonymously().catch(e=>showErrorBox('Auth: ' + e.message));
    auth.onAuthStateChanged(u => console.log('Auth ok?', !!u));

    // ---------- Utils ----------
    const $ = s => document.querySelector(s);
    const el = (t,cls)=>{const n=document.createElement(t); if(cls) n.className=cls; return n;}
    const escapeHTML = s => String(s||'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    const escapeAttr = s => String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');
    const norm = v => String(v||'').trim().toLowerCase().replace(/\s+/g,'');

    let PROG = { 'team-a': null, 'team-b': null };
    function bothTeamsDone(){
      const ta = DATA?.teams?.find(t=>t.id==='team-a');
      const tb = DATA?.teams?.find(t=>t.id==='team-b');
      const a = PROG['team-a'], b = PROG['team-b'];
      const aDone = a && ta && (a.solved||[]).filter(Boolean).length === (ta.puzzles?.length||0) && (ta.puzzles?.length||0) > 0;
      const bDone = b && tb && (b.solved||[]).filter(Boolean).length === (tb.puzzles?.length||0) && (tb.puzzles?.length||0) > 0;
      return !!(aDone && bDone);
    }

    const rref = path => db.ref(`rooms/${ROOM}/${path}`);

    function renderMarkdown(src){
      if(!src) return '';
      let out = escapeHTML(src);
      out = out.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
      out = out.replace(/\*(.+?)\*/g, '<i>$1</i>');
      out = out.replace(/(\r?\n){2,}/g, '</p><p>');
      out = out.replace(/\r?\n/g, '<br>');
      return '<p>'+out+'</p>';
    }

    async function sha256Hex(str){
      const buf = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest('SHA-256', buf);
      return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    const uid = (p='id') => p + '-' + Math.random().toString(36).slice(2,10);

    // ---------- App State ----------
    let ROOM = '';
    let TEAM = '';
    let ADMIN = false;
    let DATA = null;

    // ---------- Live-Listener ----------
    async function attachLiveListeners(){
      rref('data').on('value', s => { DATA = s.val(); refreshLive(); });
      rref('progress/team-a').on('value', s => { PROG['team-a'] = s.val(); refreshLive(); });
      rref('progress/team-b').on('value', s => { PROG['team-b'] = s.val(); refreshLive(); });
    }

    function refreshLive(){
      document.querySelectorAll('[data-live-dash]').forEach(d=>{
        const compact = d.getAttribute('data-live-dash') === 'compact';
        d.innerHTML = liveDashboardHTML(compact);
      });
      const btn = document.querySelector('#go-final');
      if(btn){
        const allow = bothTeamsDone() && (DATA?.finale?.enabled);
        btn.disabled = !allow;
        btn.style.opacity = allow? '1' : '0.6';
        btn.style.cursor = allow? 'pointer' : 'not-allowed';
      }
    }

    function liveDashboardHTML(compact=false){
      const ta = DATA?.teams?.find(t=>t.id==='team-a'); 
      const tb = DATA?.teams?.find(t=>t.id==='team-b');
      const pa = PROG['team-a'] || {solved:[], index:0, finished:false};
      const pb = PROG['team-b'] || {solved:[], index:0, finished:false};
      const as = (pa.solved||[]).filter(Boolean).length, at = ta? ta.puzzles.length:0;
      const bs = (pb.solved||[]).filter(Boolean).length, bt = tb? tb.puzzles.length:0;
      const pct = (s,t)=> t? Math.round(s/t*100):0;
      return `
        <div class="grid ${compact?'':'cols-2'}">
          <div class="panel" style="background:linear-gradient(180deg, rgba(12,20,34,.9), rgba(8,14,24,.85))">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div><div class="kbd">${(ta?.name)||'Team Alpha'}</div><div class="small muted">${as}/${at} RÃ¤tsel</div></div>
              <div class="pill ${pa.finished?'':'muted'}">${pa.finished?'bereit fÃ¼rs Finale':'arbeitetâ€¦'}</div>
            </div>
            <div class="spc"></div>
            <div class="progress"><div style="width:${pct(as,at)}%"></div></div>
          </div>
          <div class="panel" style="background:linear-gradient(180deg, rgba(12,20,34,.9), rgba(8,14,24,.85))">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div><div class="kbd">${(tb?.name)||'Team Bravo'}</div><div class="small muted">${bs}/${bt} RÃ¤tsel</div></div>
              <div class="pill ${pb.finished?'':'muted'}">${pb.finished?'bereit fÃ¼rs Finale':'arbeitetâ€¦'}</div>
            </div>
            <div class="spc"></div>
            <div class="progress"><div style="width:${pct(bs,bt)}%"></div></div>
          </div>
        </div>
        <div class="spc"></div>
        <div class="note small">Finale: ${bothTeamsDone()? '<b>bereit</b> âœ…' : 'wartet auf beide Teamsâ€¦'}</div>
      `;
    }

    // ---------- Seed-Daten ----------
    function seedData(){
      return {
        title: 'Rettungsleitstelle â€“ HACKED',
        introText: '**Achtung Einsatzleitung!**\\nEin Angreifer versucht, die Leitstelle zu Ã¼bernehmen. Zwei Teams sichern parallel die Systeme.',
        teams: [
          { id: 'team-a', name: 'Team Alpha', puzzles: [
            { id: uid('a'), title:'Erstaufnahme', body:'**Patientendaten** korrekt prÃ¼fen.', answers:['alpha'], hint:'Stichwort Einsatzprotokoll', input:'text', afterText:'<b>Gute Arbeit.</b> Meldet euch beim Dispatcher.' }
          ]},
          { id: 'team-b', name: 'Team Bravo', puzzles: [
            { id: uid('b'), title:'Routenkontrolle', body:'*Navigation* der RTWs prÃ¼fen.', answers:['bravo'], hint:'Rettungswege!', input:'text', afterText:'Route stabil.' }
          ]}
        ],
        finale: { enabled:true, title:'Sperrcode der Zentrale', body:'Beide Teams geben die finalen Codes zusammen ein.' }
      };
    }

    async function ensureProgressShape(teamId){
      const t = (DATA?.teams||[]).find(t=>t.id===teamId);
      if(!t) return;
      const solved = Array.from({length: t.puzzles.length}, ()=>false);
      const ref = rref(`progress/${teamId}`);
      const snap = await ref.get();
      if(!snap.exists()){
        await ref.set({ index:0, solved, finished:false });
      }else{
        const val = snap.val()||{};
        const need = t.puzzles.length;
        const cur = Array.isArray(val.solved)? val.solved : [];
        if(cur.length !== need){
          const next = Array.from({length: need}, (_,i)=> !!cur[i]);
          await ref.update({ solved: next });
        }
      }
    }

    // ---------- Views ----------
    function viewRoom(){
      const app = $('#app'); app.innerHTML='';
      const v = el('main','view'); v.innerHTML = `
        <header>
          <div class="brand">
            <div class="logo">ðŸš‘</div>
            <div>
              <div class="sig">Leitstelle</div>
              <div class="small muted">Rettungsdienst â€“ Online Escape</div>
            </div>
          </div>
          <div class="pill" id="hdr-room">â€“</div>
        </header>

        <section class="panel hero">
          <div class="title">Raum wÃ¤hlen</div>
          <p class="subtitle">Erstelle einen Raum oder tritt einem bestehenden bei.</p>
          <div class="spc"></div>
          <div class="row">
            <input id="room-id" placeholder="Raumcode (z. B. RL2025)" />
            <button class="btn" id="create">Neuen Raum erstellen</button>
            <button class="btn secondary" id="join">Raum beitreten</button>
            <button class="btn ghost" id="admin">Admin</button>
          </div>
        </section>
      `;
      app.appendChild(v);

      v.querySelector('#create').onclick = async ()=>{
        try{
          const raw = (v.querySelector('#room-id').value||'').trim(); if(!raw) return alert('Bitte Raumcode eingeben.');
          ROOM = norm(raw); $('#hdr-room').textContent = ROOM;
          const d = await rref('data').get();
          if(!d.exists()){
            const seed = seedData();
            await rref('data').set(seed);
            for(const t of seed.teams){
              const solved = Array.from({length:t.puzzles.length},()=>false);
              await rref(`progress/${t.id}`).set({ index:0, solved, finished:false });
            }
            await rref('settings/adminPINHash').set(await sha256Hex('9110'));
          }
          await attachLiveListeners();
          route('home');
        }catch(e){
          console.error(e); showErrorBox('Erstellen: '+(e?.message||e));
        }
      };

      v.querySelector('#join').onclick = async ()=>{
        try{
          const raw = (v.querySelector('#room-id').value||'').trim(); if(!raw) return alert('Bitte Raumcode eingeben.');
          ROOM = norm(raw); $('#hdr-room').textContent = ROOM;
          const snap = await rref('data').get();
          if(!snap.exists()){
            alert('Raum existiert noch nicht oder hat keine Daten â€“ bitte zuerst "Neuen Raum erstellen" (Admin).');
            return;
          }
          DATA = snap.val();
          await attachLiveListeners();
          route('home');
        }catch(e){
          console.error(e); showErrorBox('Beitreten: '+(e?.message||e));
        }
      };

      v.querySelector('#admin').onclick = ()=> route('admin-login');
    }

    function viewHome(){
      const app = $('#app'); app.innerHTML='';
      const v = el('main','view'); v.innerHTML = `
        <section class="panel">
          <div class="title">${escapeHTML(DATA?.title || 'Leitstelle')}</div>
          <div class="card">${renderMarkdown(DATA?.introText || '')}</div>
        </section>
      `;
      const dash = el('section','panel'); dash.setAttribute('data-live-dash','full'); dash.innerHTML = liveDashboardHTML(false);
      v.appendChild(dash);

      const teams = (DATA?.teams)||[];
      const grid = el('section','panel'); grid.innerHTML = `
        <div class="title">Teamauswahl</div>
        <div class="grid cols-2">
          ${teams.map(t=>`
            <button class="panel" data-team="${escapeAttr(t.id)}" style="text-align:left">
              <div class="row" style="justify-content:space-between;align-items:center">
                <div>
                  <div class="kbd" style="font-size:1.1rem">${escapeHTML(t.name)}</div>
                  <div class="small muted">${t.puzzles.length} RÃ¤tsel</div>
                </div>
                <div class="pill">${t.id==='team-a'?'ALPHA':'BRAVO'}</div>
              </div>
            </button>
          `).join('')}
        </div>
      `;
      v.appendChild(grid);
      app.appendChild(v);

      v.querySelectorAll('[data-team]').forEach(b=> b.onclick = async ()=>{
        TEAM = b.getAttribute('data-team');
        await ensureProgressShape(TEAM);
        route('intro');
      });
    }

    function viewIntro(){
      const app = $('#app'); app.innerHTML='';
      const v = el('main','view'); v.innerHTML = `
        <section class="panel">
          <div class="title">${escapeHTML((DATA?.teams||[]).find(t=>t.id===TEAM)?.name || 'Team')}</div>
          <div class="card">${renderMarkdown(DATA?.introText || '')}</div>
          <div class="spc"></div>
          <button class="btn" id="start">Start</button>
        </section>
      `;
      app.appendChild(v);
      v.querySelector('#start').onclick = ()=> route('puzzle');
    }

    function viewPuzzle(){
      const app = $('#app'); app.innerHTML='';
      const team = (DATA?.teams||[]).find(t=>t.id===TEAM); if(!team) return route('home');
      const prog = PROG[TEAM] || { index:0, solved:Array.from({length:team.puzzles.length},()=>false), finished:false };
      const idx = Math.min(prog.index, team.puzzles.length-1);
      const pz = team.puzzles[idx];

      const v = el('main','view'); v.innerHTML = `
        <section class="panel">
          <div class="title">${escapeHTML(pz.title)}</div>
          <div class="card">${renderMarkdown(pz.body || '')}</div>
          <div class="spc"></div>
          <form id="f">
            ${pz.input==='number'
              ? '<input id="ans" inputmode="numeric" pattern="[0-9]*" placeholder="Antwort" />'
              : '<input id="ans" placeholder="Antwort" />'}
            <div class="spc"></div>
            <div class="row">
              <button class="btn" type="submit">PrÃ¼fen</button>
              ${pz.hint? '<button class="btn ghost" id="hint" type="button">Tipp</button>':''}
            </div>
          </form>
          <div class="spc"></div>
          <div id="msg"></div>
        </section>
      `;
      app.appendChild(v);

      const dash = el('section','panel'); dash.setAttribute('data-live-dash','compact'); dash.innerHTML = liveDashboardHTML(true);
      app.appendChild(dash);

      if(pz.hint){ v.querySelector('#hint').onclick = ()=> { alert(pz.hint); }; }

      v.querySelector('#f').onsubmit = async (e)=>{
        e.preventDefault();
        try{
          const val = (v.querySelector('#ans').value||'').trim();
          const ok = (pz.answers||[]).some(a=> String(a).trim().toLowerCase() === val.toLowerCase());
          const m = $('#msg');
          if(!ok){ m.innerHTML = '<div class="error">Leider falsch.</div>'; return; }
          m.innerHTML = pz.afterText || '<div class="note">Korrekt!</div>';

          const ref = rref(`progress/${TEAM}`);
          const snap = await ref.get();
          let state = snap.val() || { index:0, solved:Array.from({length:team.puzzles.length},()=>false), finished:false };
          state.solved[idx] = true;
          if(idx < team.puzzles.length-1){
            state.index = idx + 1;
          }else{
            state.finished = true;
          }
          await ref.set(state);
        }catch(err){
          console.error(err); showErrorBox('Antwort speichern: '+(err?.message||err));
        }
      };
    }

    function viewWaiting(){
      const app = $('#app'); app.innerHTML='';
      const v = el('main','view'); v.innerHTML = `
        <section class="panel">
          <div class="title">Sammelpunkt</div>
          <p class="muted">Finale wird aktiviert, sobald beide Teams fertig sind.</p>
          <div class="spc"></div>
          <section class="panel" data-live-dash="full">${liveDashboardHTML(false)}</section>
          <div class="spc"></div>
          <button class="btn" id="go-final" ${(bothTeamsDone() && (DATA?.finale?.enabled)) ? '' : 'disabled style="opacity:.6;cursor:not-allowed"'}>Zum FinalrÃ¤tsel</button>
        </section>
      `;
      app.appendChild(v);
      v.querySelector('#go-final').onclick = ()=>{ if(bothTeamsDone() && (DATA?.finale?.enabled)){ route('final'); } };
    }

    function viewFinal(){
      const app = $('#app'); app.innerHTML='';
      const v = el('main','view'); v.innerHTML = `
        <section class="panel">
          <div class="title">${escapeHTML(DATA?.finale?.title || 'Finale')}</div>
          <div class="card">${renderMarkdown(DATA?.finale?.body || '')}</div>
          <div class="spc"></div>
          <div class="note">Mission abgeschlossen. Zentrale gesichert.</div>
        </section>
      `;
      app.appendChild(v);
    }

    // ---------- Admin ----------
    function viewAdminLogin(){
      const app = $('#app'); app.innerHTML='';
      const v = el('main','view'); v.innerHTML = `
        <section class="panel">
          <div class="title">Adminzugang</div>
          <div class="row">
            <input id="pin" placeholder="PIN" />
            <button class="btn" id="go">Login</button>
          </div>
        </section>
      `;
      app.appendChild(v);
      v.querySelector('#go').onclick = async ()=>{
        try{
          const pin = (v.querySelector('#pin').value||'').trim();
          if(!pin) return alert('Bitte PIN eingeben.');
          const hashSnap = await rref('settings/adminPINHash').get();
          const hash = hashSnap.val();
          if(hash && hash === await sha256Hex(pin)){
            ADMIN = true; route('admin');
          }else{
            alert('PIN falsch.');
          }
        }catch(e){
          console.error(e); showErrorBox('Admin-Login: '+(e?.message||e));
        }
      };
    }

    function editPuzzle(team, puzzle, index){
      const isNew = !puzzle;
      puzzle = puzzle || { id: uid(team.id+'-pz'), title:'Neues RÃ¤tsel', body:'', answers:[], hint:'', input:'text', afterText:'' };

      const ov = document.createElement('div'); ov.className='modal-overlay';
      const panel = document.createElement('div'); panel.className='panel modal-panel';
      const header = document.createElement('div'); header.className='modal-header row';
      const title = document.createElement('div'); title.className='title'; title.textContent = isNew?'RÃ¤tsel hinzufÃ¼gen':'RÃ¤tsel bearbeiten';
      const actions = document.createElement('div'); actions.className='row'; actions.style.gap='8px'; actions.style.flex='0 0 auto';
      const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='Speichern';
      const closeBtn = document.createElement('button'); closeBtn.className='btn secondary'; closeBtn.textContent='SchlieÃŸen';
      actions.appendChild(saveBtn); actions.appendChild(closeBtn);
      header.appendChild(title); header.appendChild(actions);
      const content = document.createElement('div');

      function label(t){ const l=document.createElement('label'); l.textContent=t; return l; }
      function spacer(){ const s=document.createElement('div'); s.className='spc'; return s; }
      function row(){ const r=document.createElement('div'); r.className='row'; return r; }

      content.appendChild(spacer()); content.appendChild(label('Titel'));
      const t = document.createElement('input'); t.id='t'; t.value=puzzle.title||''; content.appendChild(t);

      content.appendChild(spacer()); content.appendChild(label('Text (Markdown)'));
      const b = document.createElement('textarea'); b.id='b'; b.value=puzzle.body||''; content.appendChild(b);

      content.appendChild(spacer());
      const r1=row(), c1=document.createElement('div'), c2=document.createElement('div');
      c1.appendChild(label('LÃ¶sung(en) (eine pro Zeile)'));
      const a=document.createElement('textarea'); a.id='a'; a.value=(puzzle.answers||[]).join('\n'); c1.appendChild(a);
      c2.appendChild(label('Eingabefeld'));
      const sel=document.createElement('select'); sel.id='in';
      const o1=document.createElement('option'); o1.value='text'; o1.text='Text/Code';
      const o2=document.createElement('option'); o2.value='number'; o2.text='Nur Zahlen';
      sel.appendChild(o1); sel.appendChild(o2); sel.value=puzzle.input||'text';
      c2.appendChild(sel); r1.appendChild(c1); r1.appendChild(c2); content.appendChild(r1);

      content.appendChild(spacer()); content.appendChild(label('Tipp (optional)'));
      const h=document.createElement('input'); h.id='h'; h.value=puzzle.hint||''; content.appendChild(h);

      content.appendChild(spacer()); content.appendChild(label('Zwischentext nach LÃ¶sung (HTML erlaubt)'));
      const aft=document.createElement('textarea'); aft.id='aft'; aft.value=puzzle.afterText||''; content.appendChild(aft);

      panel.appendChild(header); panel.appendChild(content); ov.appendChild(panel); document.body.appendChild(ov);

      closeBtn.onclick = ()=> ov.remove();
      saveBtn.onclick = async ()=>{
        try{
          const P = {
            id: puzzle.id || uid(team.id+'-pz'),
            title: t.value,
            body: b.value,
            answers: (a.value||'').split(/\n/).map(s=>s.trim()).filter(Boolean),
            hint: h.value,
            input: sel.value,
            afterText: aft.value
          };
          if(isNew){ team.puzzles.push(P); } else { team.puzzles[index]=P; }
          await rref('data').set(DATA);
          await ensureProgressShape(team.id);
          ov.remove();
          alert('Gespeichert.');
        }catch(e){
          console.error(e); showErrorBox('RÃ¤tsel speichern: '+(e?.message||e));
        }
      };
    }

    function viewAdmin(){
      if(!ADMIN) return route('admin-login');
      const app = $('#app'); app.innerHTML='';
      const v = el('main','view'); v.innerHTML = `
        <section class="panel">
          <div class="title">Admin â€“ Raum ${escapeHTML(ROOM)}</div>
          <div class="row">
            <button class="btn" id="back">ZurÃ¼ck</button>
            <div></div>
            <input id="newpin" placeholder="Neue PIN (optional)"/>
            <button class="btn secondary" id="savepin">PIN speichern</button>
          </div>
        </section>

        <section class="panel">
          <div class="title">Einleitung</div>
          <textarea id="intro">${escapeHTML(DATA?.introText||'')}</textarea>
          <div class="spc"></div>
          <button class="btn" id="saveIntro">Einleitung speichern</button>
        </section>

        <section class="panel">
          <div class="title">Teams & RÃ¤tsel</div>
          <div class="grid cols-2" id="teams"></div>
        </section>

        <section class="panel">
          <div class="title">Finale</div>
          <label><input type="checkbox" id="finOn" ${DATA?.finale?.enabled?'checked':''}/> Finale aktiviert</label>
          <div class="spc"></div>
          <label>Titel</label><input id="finTitle" value="${escapeAttr(DATA?.finale?.title||'')}"/>
          <div class="spc"></div>
          <label>Text (Markdown)</label><textarea id="finBody">${escapeHTML(DATA?.finale?.body||'')}</textarea>
          <div class="spc"></div>
          <button class="btn" id="saveFinal">Finale speichern</button>
        </section>
      `;
      app.appendChild(v);

      v.querySelector('#back').onclick = ()=> route('home');
      v.querySelector('#saveIntro').onclick = async ()=>{
        try{
          DATA.introText = v.querySelector('#intro').value;
          await rref('data').set(DATA);
          alert('Einleitung gespeichert.');
        }catch(e){ showErrorBox('Speichern: '+(e?.message||e)); }
      };
      v.querySelector('#savepin').onclick = async ()=>{
        try{
          const pin = (v.querySelector('#newpin').value||'').trim();
          if(!pin) return alert('Bitte neue PIN eingeben.');
          await rref('settings/adminPINHash').set(await sha256Hex(pin));
          alert('PIN gespeichert.');
        }catch(e){ showErrorBox('PIN speichern: '+(e?.message||e)); }
      };
      v.querySelector('#saveFinal').onclick = async ()=>{
        try{
          DATA.finale = DATA.finale || {};
          DATA.finale.enabled = v.querySelector('#finOn').checked;
          DATA.finale.title   = v.querySelector('#finTitle').value;
          DATA.finale.body    = v.querySelector('#finBody').value;
          await rref('data').set(DATA);
          alert('Finale gespeichert.');
        }catch(e){ showErrorBox('Finale speichern: '+(e?.message||e)); }
      };

      const box = v.querySelector('#teams');
      (DATA?.teams||[]).forEach((t,ti)=>{
        const card = el('div','panel');
        card.innerHTML = `
          <div class="row" style="justify-content:space-between;align-items:center">
            <div><div class="kbd">${escapeHTML(t.name)}</div><div class="small muted">${t.puzzles.length} RÃ¤tsel</div></div>
            <div class="row" style="flex:0 0 auto; gap:8px">
              <button class="btn" data-add="${escapeAttr(t.id)}">RÃ¤tsel hinzufÃ¼gen</button>
            </div>
          </div>
          <div class="spc"></div>
          <div class="grid">
            ${t.puzzles.map((p,pi)=>`
              <div class="panel" style="background:linear-gradient(180deg, rgba(10,18,30,.7), rgba(10,18,30,.5))">
                <div class="row" style="justify-content:space-between;align-items:center">
                  <div><b>${escapeHTML(p.title)}</b><div class="small muted">${p.input==='number'?'Zahl':'Text'}</div></div>
                  <div class="row" style="flex:0 0 auto; gap:8px">
                    <button class="btn secondary" data-edit="${escapeAttr(t.id)}:${pi}">Bearbeiten</button>
                    <button class="btn ghost" data-del="${escapeAttr(t.id)}:${pi}">LÃ¶schen</button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        box.appendChild(card);
      });

      box.querySelectorAll('[data-add]').forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.getAttribute('data-add');
          const team = (DATA?.teams||[]).find(x=>x.id===id);
          editPuzzle(team, null, team.puzzles.length);
        };
      });
      box.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.onclick = ()=>{
          const [id,pi] = btn.getAttribute('data-edit').split(':');
          const team = (DATA?.teams||[]).find(x=>x.id===id);
          editPuzzle(team, team.puzzles[+pi], +pi);
        };
      });
      box.querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick = async ()=>{
          if(!confirm('Dieses RÃ¤tsel wirklich lÃ¶schen?')) return;
          const [id,pi] = btn.getAttribute('data-del').split(':');
          const team = (DATA?.teams||[]).find(x=>x.id===id);
          team.puzzles.splice(+pi,1);
          await rref('data').set(DATA);
          await ensureProgressShape(id);
          viewAdmin();
        };
      });
    }

    // ---------- Router ----------
    function route(screen){
      switch(screen){
        case 'home':    return viewHome();
        case 'intro':   return viewIntro();
        case 'puzzle':  return viewPuzzle();
        case 'waiting': return viewWaiting();
        case 'final':   return viewFinal();
        case 'admin-login': return viewAdminLogin();
        case 'admin':   return viewAdmin();
        default:        return viewRoom();
      }
    }

    // ---------- Boot ----------
    route('room'); // Start: Raumcode wÃ¤hlen

  })();
  </script>
</body>
</html>
